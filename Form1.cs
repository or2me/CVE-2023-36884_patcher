using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using Microsoft.Win32;
using System.Security.Principal;

namespace CVE_2023_36884_patcher
{
    public partial class Form1 : Form
    {
        public Form1()
        {
            InitializeComponent();
            if (!IsAdmin())
            {
                Console.WriteLine("please run me as Administrator");
                button1.Text = "请使用管理员权限运行";
                button1.Enabled = false;

            }
            if (!IsOfficeInstalled())
            {
                button1.Text = "此计算机不受影响";
                button1.Enabled = false;
            }
        }
        public static bool TestRegistryValue(string path, string value, bool showValue)
        {
            try
            {
                RegistryKey registryKey = Registry.LocalMachine.OpenSubKey(path);
                if (registryKey != null)
                {
                    object registryValue = registryKey.GetValue(value);
                    if (registryValue != null)
                    {
                        if (showValue)
                        {
                            Console.WriteLine(registryValue.ToString());
                        }
                        else
                        {
                            return true;
                        }
                    }
                }
            }
            catch (Exception)
            {
                return false;
            }

            return false;
        }



        public static bool IsOfficeInstalled()
        {
            string officeRegistryPath = @"SOFTWARE\Microsoft\Office\16.0";

            using (RegistryKey key = Registry.LocalMachine.OpenSubKey(officeRegistryPath))
            {
                return key != null;
            }
        }



        public static bool IsAdmin()
        {
            WindowsIdentity identity = WindowsIdentity.GetCurrent();
            WindowsPrincipal principal = new WindowsPrincipal(identity);

            // 判断是否属于管理员组（Administrator）
            return principal.IsInRole(WindowsBuiltInRole.Administrator);
        }


        private void button1_Click(object sender, EventArgs e)
        {
            string key = @"SOFTWARE\Policies\Microsoft\Internet Explorer\Main\FeatureControl\FEATURE_BLOCK_CROSS_PROTOCOL_FILE_NAVIGATION";
            RegistryKey baseRegistryKey = Registry.LocalMachine;
            RegistryKey subKey = baseRegistryKey.CreateSubKey(key);

            string[] registryValues = { "Graph.exe", "MSAccess.exe", "MSPub.exe", "PowerPoint.exe", "Visio.exe", "WinProj.exe", "WinWord.exe", "WordPad.exe" };

            foreach (string value in registryValues)
            {
                if (!TestRegistryValue(key, value, false))
                {
                    subKey.SetValue(value, 1);
                    MessageBox.Show(value + " 打好补丁了");
                }
                else
                {
                    MessageBox.Show(value + " 打过补丁了");

                }
            }
        }

        private void linkLabel1_LinkClicked(object sender, LinkLabelLinkClickedEventArgs e)
        {
            System.Diagnostics.Process.Start("https://www.nosugartech.com/");

        }
    }
}
